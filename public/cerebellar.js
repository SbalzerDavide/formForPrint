// I dati estratti dal CSV: [giorni gestazionali, P5, P50, P95]
const cerebellumData = [
  // Format: [totalDays, p5, median, p95]
  // Week 14
  [14 * 7 + 0, 12, 14, 15],
  [14 * 7 + 1, 12, 14, 15],
  [14 * 7 + 2, 12, 14, 15],
  [14 * 7 + 3, 12, 14, 15],
  [14 * 7 + 4, 12, 14, 15],
  [14 * 7 + 5, 12, 14, 15],
  [14 * 7 + 6, 12, 14, 15],
  // Week 15
  [15 * 7 + 0, 13, 15, 17],
  [15 * 7 + 1, 13, 15, 17],
  [15 * 7 + 2, 13, 15, 17],
  [15 * 7 + 3, 13, 15, 17],
  [15 * 7 + 4, 13, 15, 17],
  [15 * 7 + 5, 13, 15, 17],
  [15 * 7 + 6, 13, 15, 17],
  // Week 16
  [16 * 7 + 0, 14, 16, 18],
  [16 * 7 + 1, 14, 16, 18],
  [16 * 7 + 2, 14, 16, 18],
  [16 * 7 + 3, 14, 16, 18],
  [16 * 7 + 4, 14, 16, 18],
  [16 * 7 + 5, 14, 16, 18],
  [16 * 7 + 6, 14, 16, 18],
  // Week 17
  [17 * 7 + 0, 15, 17, 19],
  [17 * 7 + 1, 15, 17, 19],
  [17 * 7 + 2, 15, 17, 19],
  [17 * 7 + 3, 15, 17, 19],
  [17 * 7 + 4, 15, 17, 19],
  [17 * 7 + 5, 15, 17, 19],
  [17 * 7 + 6, 15, 17, 19],
  // Week 18
  [18 * 7 + 0, 16, 18, 21],
  [18 * 7 + 1, 16, 18, 21],
  [18 * 7 + 2, 16, 18, 21],
  [18 * 7 + 3, 16, 18, 21],
  [18 * 7 + 4, 16, 18, 21],
  [18 * 7 + 5, 16, 18, 21],
  [18 * 7 + 6, 16, 18, 21],
  // Week 19
  [19 * 7 + 0, 17, 20, 22],
  [19 * 7 + 1, 17, 20, 22],
  [19 * 7 + 2, 17, 20, 22],
  [19 * 7 + 3, 17, 20, 22],
  [19 * 7 + 4, 17, 20, 22],
  [19 * 7 + 5, 17, 20, 22],
  [19 * 7 + 6, 17, 20, 22],
  // Week 20
  [20 * 7 + 0, 19, 21, 24],
  [20 * 7 + 1, 19, 21, 24],
  [20 * 7 + 2, 19, 21, 24],
  [20 * 7 + 3, 19, 21, 24],
  [20 * 7 + 4, 19, 21, 24],
  [20 * 7 + 5, 19, 21, 24],
  [20 * 7 + 6, 19, 21, 24],
  // Week 21
  [21 * 7 + 0, 20, 22, 25],
  [21 * 7 + 1, 20, 22, 25],
  [21 * 7 + 2, 20, 22, 25],
  [21 * 7 + 3, 20, 22, 25],
  [21 * 7 + 4, 20, 22, 25],
  [21 * 7 + 5, 20, 22, 25],
  [21 * 7 + 6, 20, 22, 25],
  // Week 22
  [22 * 7 + 0, 21, 24, 27],
  [22 * 7 + 1, 21, 24, 27],
  [22 * 7 + 2, 21, 24, 27],
  [22 * 7 + 3, 21, 24, 27],
  [22 * 7 + 4, 21, 24, 27],
  [22 * 7 + 5, 21, 24, 27],
  [22 * 7 + 6, 21, 24, 27],
  // Week 23
  [23 * 7 + 0, 22, 25, 28],
  [23 * 7 + 1, 22, 25, 28],
  [23 * 7 + 2, 22, 25, 28],
  [23 * 7 + 3, 22, 25, 28],
  [23 * 7 + 4, 22, 25, 28],
  [23 * 7 + 5, 22, 25, 28],
  [23 * 7 + 6, 22, 25, 28],
  // Week 24
  [24 * 7 + 0, 24, 26, 30],
  [24 * 7 + 1, 24, 26, 30],
  [24 * 7 + 2, 24, 26, 30],
  [24 * 7 + 3, 24, 26, 30],
  [24 * 7 + 4, 24, 26, 30],
  [24 * 7 + 5, 24, 26, 30],
  [24 * 7 + 6, 24, 26, 30],
  // Week 25
  [25 * 7 + 0, 25, 28, 31],
  [25 * 7 + 1, 25, 28, 31],
  [25 * 7 + 2, 25, 28, 31],
  [25 * 7 + 3, 25, 28, 31],
  [25 * 7 + 4, 25, 28, 31],
  [25 * 7 + 5, 25, 28, 31],
  [25 * 7 + 6, 25, 28, 31],
  // Week 26
  [26 * 7 + 0, 26, 29, 33],
  [26 * 7 + 1, 26, 29, 33],
  [26 * 7 + 2, 26, 29, 33],
  [26 * 7 + 3, 26, 29, 33],
  [26 * 7 + 4, 26, 29, 33],
  [26 * 7 + 5, 26, 29, 33],
  [26 * 7 + 6, 26, 29, 33],
  // Week 27
  [27 * 7 + 0, 27, 31, 34],
  [27 * 7 + 1, 27, 31, 34],
  [27 * 7 + 2, 27, 31, 34],
  [27 * 7 + 3, 27, 31, 34],
  [27 * 7 + 4, 27, 31, 34],
  [27 * 7 + 5, 27, 31, 34],
  [27 * 7 + 6, 27, 31, 34],
  // Week 28
  [28 * 7 + 0, 29, 32, 36],
  [28 * 7 + 1, 29, 32, 36],
  [28 * 7 + 2, 29, 32, 36],
  [28 * 7 + 3, 29, 32, 36],
  [28 * 7 + 4, 29, 32, 36],
  [28 * 7 + 5, 29, 32, 36],
  [28 * 7 + 6, 29, 32, 36],
  // Week 29
  [29 * 7 + 0, 30, 33, 37],
  [29 * 7 + 1, 30, 33, 37],
  [29 * 7 + 2, 30, 33, 37],
  [29 * 7 + 3, 30, 33, 37],
  [29 * 7 + 4, 30, 33, 37],
  [29 * 7 + 5, 30, 33, 37],
  [29 * 7 + 6, 30, 33, 37],
  // Week 30
  [30 * 7 + 0, 31, 35, 39],
  [30 * 7 + 1, 31, 35, 39],
  [30 * 7 + 2, 31, 35, 39],
  [30 * 7 + 3, 31, 35, 39],
  [30 * 7 + 4, 31, 35, 39],
  [30 * 7 + 5, 31, 35, 39],
  [30 * 7 + 6, 31, 35, 39],
  // Week 31
  [31 * 7 + 0, 32, 36, 40],
  [31 * 7 + 1, 32, 36, 40],
  [31 * 7 + 2, 32, 36, 40],
  [31 * 7 + 3, 32, 36, 40],
  [31 * 7 + 4, 32, 36, 40],
  [31 * 7 + 5, 32, 36, 40],
  [31 * 7 + 6, 32, 36, 40],
  // Week 32
  [32 * 7 + 0, 34, 37, 42],
  [32 * 7 + 1, 34, 37, 42],
  [32 * 7 + 2, 34, 37, 42],
  [32 * 7 + 3, 34, 37, 42],
  [32 * 7 + 4, 34, 37, 42],
  [32 * 7 + 5, 34, 37, 42],
  [32 * 7 + 6, 34, 37, 42],
  // Week 33
  [33 * 7 + 0, 35, 39, 43],
  [33 * 7 + 1, 35, 39, 43],
  [33 * 7 + 2, 35, 39, 43],
  [33 * 7 + 3, 35, 39, 43],
  [33 * 7 + 4, 35, 39, 43],
  [33 * 7 + 5, 35, 39, 43],
  [33 * 7 + 6, 35, 39, 43],
  // Week 34
  [34 * 7 + 0, 36, 40, 44],
  [34 * 7 + 1, 36, 40, 44],
  [34 * 7 + 2, 36, 40, 44],
  [34 * 7 + 3, 36, 40, 44],
  [34 * 7 + 4, 36, 40, 44],
  [34 * 7 + 5, 36, 40, 44],
  [34 * 7 + 6, 36, 40, 44],
  // Week 35
  [35 * 7 + 0, 37, 41, 46],
  [35 * 7 + 1, 37, 41, 46],
  [35 * 7 + 2, 37, 41, 46],
  [35 * 7 + 3, 37, 41, 46],
  [35 * 7 + 4, 37, 41, 46],
  [35 * 7 + 5, 37, 41, 46],
  [35 * 7 + 6, 37, 41, 46],
  // Week 36
  [36 * 7 + 0, 38, 42, 47],
  [36 * 7 + 1, 38, 42, 47],
  [36 * 7 + 2, 38, 42, 47],
  [36 * 7 + 3, 38, 42, 47],
  [36 * 7 + 4, 38, 42, 47],
  [36 * 7 + 5, 38, 42, 47],
  [36 * 7 + 6, 38, 42, 47],
  // Week 37
  [37 * 7 + 0, 39, 43, 48],
  [37 * 7 + 1, 39, 43, 48],
  [37 * 7 + 2, 39, 43, 48],
  [37 * 7 + 3, 39, 43, 48],
  [37 * 7 + 4, 39, 43, 48],
  [37 * 7 + 5, 39, 43, 48],
  [37 * 7 + 6, 39, 43, 48],
  // Week 38
  [38 * 7 + 0, 40, 44, 49],
  [38 * 7 + 1, 40, 44, 49],
  [38 * 7 + 2, 40, 44, 49],
  [38 * 7 + 3, 40, 44, 49],
  [38 * 7 + 4, 40, 44, 49],
  [38 * 7 + 5, 40, 44, 49],
  [38 * 7 + 6, 40, 44, 49],
  // Week 39
  [39 * 7 + 0, 41, 45, 51],
  [39 * 7 + 1, 41, 45, 51],
  [39 * 7 + 2, 41, 45, 51],
  [39 * 7 + 3, 41, 45, 51],
  [39 * 7 + 4, 41, 45, 51],
  [39 * 7 + 5, 41, 45, 51],
  [39 * 7 + 6, 41, 45, 51]
];

// Calcola sigma da P95 e P50 (assumendo distribuzione normale)
function calcSigma(p50, p95) {
  return (p95 - p50) / 1.645;
}

// Interpolazione lineare
function interpolate(day, columnIndex) {
  for (let i = 0; i < cerebellumData.length - 1; i++) {
    const [d1, ...vals1] = cerebellumData[i];
    const [d2, ...vals2] = cerebellumData[i + 1];
    if (day >= d1 && day <= d2) {
      const v1 = vals1[columnIndex];
      const v2 = vals2[columnIndex];
      const fraction = (day - d1) / (d2 - d1);
      return v1 + fraction * (v2 - v1);
    }
  }
  // extrapolazione semplice
  const last = cerebellumData[cerebellumData.length - 1];
  return last[columnIndex];
}

function erf(x) {
  // Abramowitz and Stegun formula 7.1.26
  const sign = (x >= 0) ? 1 : -1;
  x = Math.abs(x);

  const a1 =  0.254829592;
  const a2 = -0.284496736;
  const a3 =  1.421413741;
  const a4 = -1.453152027;
  const a5 =  1.061405429;
  const p  =  0.3275911;

  const t = 1 / (1 + p * x);
  const y = 1 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);

  return sign * y;
}

function normalCDF(z) {
  return 0.5 * (1 + erf(z / Math.sqrt(2)));
}

window.estimateCerebelarPercentile = function(weeks, days, measurement) {
  const totalDays = weeks * 7 + days;
  const mu = interpolate(totalDays, 1);     // mediana
  const p95 = interpolate(totalDays, 2);    // 95Â°
  const sigma = calcSigma(mu, p95);
  const z = (measurement - mu) / sigma;
  const percentile = normalCDF(z) * 100;
  return {
    percentile: Math.round(percentile * 100) / 100,
    mu: Math.round(mu * 100) / 100,
    sigma: Math.round(sigma * 100) / 100
  };
}

// Esempio di utilizzo
const result = estimateCerebelarPercentile(22, 3, 22); // 22 settimane + 3 giorni, misura = 22 mm
console.log(result);